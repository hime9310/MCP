MCPサーバ（PoC環境）の構築に向けたテスト仕様書案を作成しました。
PoCフェーズであることを踏まえ、環境構築の正しさを検証する「構築テスト」と、Kiroから実際に利用できるかを確認する「疎通・動作確認テスト」の2段階に分けて構成しています。

---

# テスト仕様書（MCPサーバ PoC環境）

## 1. テスト実施概要

本テストの目的は、Terraformによって構築されたECS Fargate環境が基本設計どおりに構成され、社内ネットワーク（Port 80）経由でKiro IDEからMCPサーバとして利用可能であることを検証することにある。

---

## 2. 構築検証テスト（構築直後）

インフラリソースが意図したパラメータでデプロイされているかを確認する。

| テスト項目 | 確認内容 | 確認方法 | 期待値（合格基準） |
| --- | --- | --- | --- |
| **ECSクラスタ/サービス** | サービスがACTIVEであり、タスクが1つ「RUNNING」状態であること | AWSコンソール（ECS） | サービスステータスがACTIVE、タスクがRUNNINGであること |
| **セキュリティグループ (Ingress)** | インバウンドPort 80が社内NW(CIDR)に対して許可されていること | AWSコンソール（EC2/SG） | プロトコルTCP、ポート80、ソースが指定のCIDRであること |
| **セキュリティグループ (Egress)** | アウトバウンドPort 443(HTTPS)のみが許可されていること | AWSコンソール（EC2/SG） | 宛先0.0.0.0/0に対し、ポート443以外の通信が許可されていないこと |
| **IAMロール** | タスク実行ロールに必要なポリシーが付与されていること | AWSコンソール（IAM） | `AmazonECSTaskExecutionRolePolicy`がアタッチされていること |
| **ログ出力** | CloudWatch Logsにロググループが作成されていること | AWSコンソール（CloudWatch） | 指定したパス（例: `/aws/ecs/mcp-server-dev`）が存在すること |

---

## 3. 疎通・動作確認テスト（アプリ連携）

実際の利用シーンに沿った、エンドツーエンドの疎通を確認する。

| テスト項目 | 確認内容 | 確認方法 | 期待値（合格基準） |
| --- | --- | --- | --- |
| **タスクIP取得** | 接続に必要なプライベートIPが取得できること | AWSコンソールまたはCLI | 10.x.x.x 等のVPC内プライベートIPが確認できること |
| **ネットワーク疎通** | Local PCからタスクのPort 80へ疎通ができること | コマンドプロンプト等から `curl -I http://[タスクIP]:80` | HTTP 200 OK（または製品仕様の応答）が返ること |
| **Kiro接続設定** | Kiroのjson設定ファイルにタスクIPを登録できること | Kiro設定ファイル編集 | jsonにエラーが出ず、保存が可能であること |
| **MCP機能呼び出し** | Kiro IDEからMCPサーバの機能が呼び出せること | Kiro IDE UI上の操作 | MCPサーバが提供するツールやリソースがIDE上に表示・実行されること |
| **コンテナログ確認** | 動作時のログがCloudWatchに記録されていること | CloudWatch Logs Insights | Kiroからのアクセスログや起動ログが記録されていること |

---

## 4. 異常系テスト（任意）

余力があれば実施する、トラブルシューティングのための確認項目。

| テスト項目 | 確認内容 | 確認方法 | 期待値（合格基準） |
| --- | --- | --- | --- |
| **タスク再起動** | タスクを停止させ、新しいIPで自動復旧すること | タスクを手動で停止（Stop） | 数分以内に新しいタスクがRUNNINGになり、異なるIPが付与されること |
| **不正ポート遮断** | Port 80以外のポート（例: 8000）でアクセスが拒否されること | `telnet [タスクIP] 8000` | タイムアウトまたは接続拒否となること |

---

### テスト実施にあたっての注意点

* **IP変動の再認識**: タスク再起動テストを行うとIPが変わります。PoC運用中は、IPが変わるたびに「Kiro接続設定」テストを再実施し、運用負荷の実感値をチームへフィードバックしてください。
* **Marketplaceイメージ仕様**: 疎通テストでエラーが出る場合、コンテナ内部で実際にPort 80でリッスンできているかを `aws ecs execute-command` 等を用いて確認してください。